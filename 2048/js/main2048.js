function prepareForMobile(){documentWidth>500?(gridContainerWidth=500,cellSideLength=100,cellSpace=20,$(".footer").show()):($("#grid-container").css({width:gridContainerWidth-2*cellSpace,height:gridContainerWidth-2*cellSpace,padding:cellSpace,"border-radius":.02*gridContainerWidth}),$(".grid-cell").css({width:cellSideLength,height:cellSideLength,"border-radius":.02*cellSideLength}),$(".footer").hide())}function newgame(){init(),generateOneNumber(),generateOneNumber()}function init(){for(var e=0;e<4;e++)for(var o=0;o<4;o++){var r=$("#grid-cell-"+e+"-"+o);r.css("top",getPosTop(e,o)),r.css("left",getPosLeft(e,o))}for(e=0;e<4;e++){board[e]=new Array,hasConflicted[e]=new Array;for(o=0;o<4;o++)board[e][o]=0,hasConflicted[e][o]=!1}updateBoardView(),score=0,updateScore(score)}function updateBoardView(){$(".number-cell").remove();for(var e=0;e<4;e++)for(var o=0;o<4;o++){$("#grid-container").append('<div class="number-cell" id="number-cell-'+e+"-"+o+'"></div>');var r=$("#number-cell-"+e+"-"+o);0==board[e][o]?r.css({width:"0px",height:"0px",top:getPosTop(e,o)+cellSideLength/2,left:getPosLeft(e,o)+cellSideLength/2}):(r.css({width:cellSideLength,height:cellSideLength,top:getPosTop(e,o),left:getPosLeft(e,o),"background-color":getNumberBackgroundColor(board[e][o]),color:getNumberColor(board[e][o])}),r.text(getNumberText(board[e][o]))),hasConflicted[e][o]=!1}$(".number-cell").css("line-height",cellSideLength+"px"),$(".number-cell").css("font-size",.22*cellSideLength+"px")}function generateOneNumber(){if(nospace(board))return!1;for(var e=parseInt(Math.floor(4*Math.random())),o=parseInt(Math.floor(4*Math.random())),r=0;r<50&&0!=board[e][o];)e=parseInt(Math.floor(4*Math.random())),o=parseInt(Math.floor(4*Math.random())),r++;if(50==r)for(var a=0;a<4;a++)for(var t=0;t<4;t++)0==board[a][t]&&(e=a,o=t);var n=Math.random()<.5?2:4;return board[e][o]=n,showNumberWithAnimation(e,o,n),!0}function moveLeft(){if(!canMoveLeft(board))return!1;for(var e=0;e<4;e++)for(var o=1;o<4;o++)if(0!=board[e][o])for(var r=0;r<o;r++)0==board[e][r]&&noBlockHorizontal(e,r,o,board)?(showMoveAnimation(e,o,e,r),board[e][r]=board[e][o],board[e][o]=0):board[e][o]!=board[e][r]||!noBlockHorizontal(e,r,o,board)||hasConflicted[e][r]||(showMoveAnimation(e,o,e,r),board[e][r]+=board[e][o],board[e][o]=0,score+=board[e][r],updateScore(score),hasConflicted[e][r]=!0);return setTimeout("updateBoardView()",200),!0}function moveUp(){if(!canMoveUp(board))return!1;for(var e=1;e<4;e++)for(var o=0;o<4;o++)if(0!=board[e][o])for(var r=0;r<e;r++)0==board[r][o]&&noBlockVertical(o,r,e,board)?(showMoveAnimation(e,o,r,o),board[r][o]=board[e][o],board[e][o]=0):board[e][o]!=board[r][o]||!noBlockVertical(o,r,e,board)||hasConflicted[r][o]||(showMoveAnimation(e,o,r,o),board[r][o]+=board[e][o],board[e][o]=0,score+=board[r][o],updateScore(score),hasConflicted[r][o]=!0);return setTimeout("updateBoardView()",200),!0}function moveRight(){if(!canMoveRight(board))return!1;for(var e=0;e<4;e++)for(var o=2;o>=0;o--)if(0!=board[e][o])for(var r=3;r>o;r--)0==board[e][r]&&noBlockHorizontal(e,o,r,board)?(showMoveAnimation(e,o,e,r),board[e][r]=board[e][o],board[e][o]=0):board[e][r]!=board[e][o]||!noBlockHorizontal(e,o,r,board)||hasConflicted[e][r]||(showMoveAnimation(e,o,e,r),board[e][r]+=board[e][o],board[e][o]=0,score+=board[e][r],updateScore(score),hasConflicted[e][r]=!0);return setTimeout("updateBoardView()",200),!0}function moveDown(){if(!canMoveDown(board))return!1;for(var e=2;e>=0;e--)for(var o=0;o<4;o++)if(0!=board[e][o])for(var r=3;r>e;r--)0==board[r][o]&&noBlockVertical(o,e,r,board)?(showMoveAnimation(e,o,r,o),board[r][o]=board[e][o],board[e][o]=0):board[e][o]!=board[r][o]||!noBlockVertical(o,e,r,board)||hasConflicted[r][o]||(showMoveAnimation(e,o,r,o),board[r][o]+=board[e][o],board[e][o]=0,score+=board[r][o],updateScore(score),hasConflicted[r][o]=!0);return setTimeout("updateBoardView()",220),!0}function isGameOver(){nospace(board)&&nomove(board)&&gameover()}function gameover(){alert("游戏结束！")}var board=new Array,score=0,hasConflicted=new Array,startx=0,starty=0,endx=0,endy=0;$(function(){prepareForMobile(),newgame()});var keys=!0;$(document).keydown(function(e){switch(e.keyCode){case 37:keys&&moveLeft()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300));break;case 38:keys&&moveUp()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300)),e.preventDefault();break;case 39:keys&&moveRight()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300));break;case 40:keys&&moveDown()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300)),e.preventDefault()}keys=!1}),$(document).keyup(function(e){keys=!0}),document.addEventListener("touchstart",function(e){startx=e.touches[0].pageX,starty=e.touches[0].pageY}),document.addEventListener("touchmove",function(e){e.preventDefault()}),document.addEventListener("touchend",function(e){endx=e.changedTouches[0].pageX,endy=e.changedTouches[0].pageY;var o=endx-startx,r=endy-starty;Math.abs(o)<.3*documentWidth&&Math.abs(r)<.3*documentWidth||(Math.abs(o)>=Math.abs(r)?o>0?moveRight()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300)):moveLeft()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300)):r>0?moveDown()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300)):moveUp()&&(setTimeout("generateOneNumber()",210),setTimeout("isGameOver()",300)))});